generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model AgentDefinition {
  id                                Int    @id @default(autoincrement())
  name                              String @unique
  role                              String
  description                       String
  toolNames                         String @default("[]") @map("tool_names")
  inputProcessorNames               String @default("[]") @map("input_processor_names")
  llmResponseProcessorNames         String @default("[]") @map("llm_response_processor_names")
  systemPromptProcessorNames        String @default("[]") @map("system_prompt_processor_names")
  toolExecutionResultProcessorNames String @default("[]") @map("tool_execution_result_processor_names")
  toolInvocationPreprocessorNames   String @default("[]") @map("tool_invocation_preprocessor_names")
  lifecycleProcessorNames           String @default("[]") @map("lifecycle_processor_names")
  skillNames                        String @default("[]") @map("skill_names")

  promptMapping AgentPromptMapping?

  @@map("agent_definitions")
}

model AgentPromptMapping {
  id                 Int    @id @default(autoincrement())
  agentDefinitionId  Int    @unique @map("agent_definition_id")
  promptName         String @map("prompt_name")
  promptCategory     String @map("prompt_category")

  agentDefinition AgentDefinition @relation(fields: [agentDefinitionId], references: [id], onDelete: Cascade)

  @@map("agent_prompt_mappings")
}

model Prompt {
  id                Int      @id @default(autoincrement())
  name              String
  category          String
  promptContent     String   @map("prompt_content")
  version           Int      @default(1)
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")
  parentId          Int?     @map("parent_id")
  isActive          Boolean  @default(true) @map("is_active")
  description       String?
  suitableForModels String?  @map("suitable_for_models")

  @@unique([name, category, version, suitableForModels], map: "uq_prompt_version")
  @@map("prompts")
}

model AgentTeamDefinition {
  id                     Int    @id @default(autoincrement())
  name                   String @unique
  description            String
  role                   String?
  nodes                  String
  coordinatorMemberName  String @map("coordinator_member_name")

  @@map("agent_team_definitions")
}

model AgentWorkflowDefinition {
  id           Int    @id @default(autoincrement())
  name         String @unique
  description  String
  nodes        String
  beginNodeId  String @map("begin_node_id")
  endNodeId    String @map("end_node_id")

  @@map("agent_workflow_definitions")
}

model TokenUsageRecord {
  id             Int      @id @default(autoincrement())
  usageRecordId  String   @unique @default(uuid()) @map("usage_record_id")
  agentId        String   @map("agent_id")
  role           String
  tokenCount     Int      @map("token_count")
  cost           Float
  createdAt      DateTime @default(now()) @map("created_at")
  llmModel       String?  @map("llm_model")

  @@map("token_usage_records")
}

model AgentArtifact {
  id            Int      @id @default(autoincrement())
  agentId       String   @map("agent_id")
  path          String
  type          String
  workspaceRoot String?  @map("workspace_root")
  url           String?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([agentId])
  @@map("agent_artifacts")
}

model McpServerConfiguration {
  id             Int      @id @default(autoincrement())
  serverId       String   @unique @map("server_id")
  transportType  String   @map("transport_type")
  enabled        Boolean  @default(true)
  toolNamePrefix String?  @map("tool_name_prefix")
  configDetails  String   @map("config_details")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("mcp_server_configurations")
}

model ChannelBinding {
  id                     Int      @id @default(autoincrement())
  provider               String
  transport              String
  accountId              String   @map("account_id")
  peerId                 String   @map("peer_id")
  threadId               String   @default("") @map("thread_id")
  targetType             String   @map("target_type")
  agentId                String?  @map("agent_id")
  teamId                 String?  @map("team_id")
  targetNodeName         String?  @map("target_node_name")
  allowTransportFallback Boolean  @default(false) @map("allow_transport_fallback")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@unique([provider, transport, accountId, peerId, threadId], map: "uq_channel_binding_route")
  @@index([agentId], map: "idx_channel_bindings_agent_id")
  @@index([teamId], map: "idx_channel_bindings_team_id")
  @@map("channel_bindings")
}

model ChannelIngressIdempotencyKey {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  firstSeenAt DateTime @default(now()) @map("first_seen_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("channel_ingress_idempotency_keys")
}

model ChannelCallbackIdempotencyKey {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  firstSeenAt DateTime @default(now()) @map("first_seen_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("channel_callback_idempotency_keys")
}

model ChannelMessageReceipt {
  id                Int      @id @default(autoincrement())
  provider          String
  transport         String
  accountId         String   @map("account_id")
  peerId            String   @map("peer_id")
  threadId          String   @default("") @map("thread_id")
  externalMessageId String   @map("external_message_id")
  turnId            String?  @map("turn_id")
  agentId           String?  @map("agent_id")
  teamId            String?  @map("team_id")
  receivedAt        DateTime @map("received_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@unique([provider, transport, accountId, peerId, threadId, externalMessageId], map: "uq_channel_message_receipt_dedupe")
  @@index([agentId, receivedAt], map: "idx_channel_message_receipts_agent_received_at")
  @@index([agentId, turnId], map: "idx_channel_message_receipts_agent_turn_id")
  @@index([teamId, receivedAt], map: "idx_channel_message_receipts_team_received_at")
  @@map("channel_message_receipts")
}

model ChannelDeliveryEvent {
  id                    Int      @id @default(autoincrement())
  provider              String
  transport             String
  accountId             String   @map("account_id")
  peerId                String   @map("peer_id")
  threadId              String   @default("") @map("thread_id")
  correlationMessageId  String?  @map("correlation_message_id")
  callbackIdempotencyKey String  @map("callback_idempotency_key")
  status                String
  errorMessage          String?  @map("error_message")
  metadataJson          String?  @map("metadata_json")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  @@unique([callbackIdempotencyKey], map: "uq_channel_delivery_events_callback_key")
  @@index([provider, transport, accountId, peerId, threadId], map: "idx_channel_delivery_events_route")
  @@map("channel_delivery_events")
}
