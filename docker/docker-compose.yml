services:
  autobyteus-server:
    container_name: autobyteus-server
    image: autobyteus-server:${AUTOBYTEUS_IMAGE_TAG:-latest}
    build:
      context: ../..
      dockerfile: autobyteus-server-ts/docker/Dockerfile.monorepo
      args:
        CHROME_VNC_TAG: ${AUTOBYTEUS_CHROME_VNC_TAG:-zh}
    cap_add:
      - SYS_ADMIN
    security_opt:
      - seccomp=unconfined
    env_file:
      - ${AUTOBYTEUS_ENV_FILE:-.env}
    environment:
      AUTOBYTEUS_WORKSPACE_ROOT: /home/autobyteus/workspace
      AUTOBYTEUS_DATA_DIR: /home/autobyteus/data
      AUTOBYTEUS_GIT_AUTH_MODE: ${AUTOBYTEUS_GIT_AUTH_MODE:-pat}
      GITHUB_USERNAME: ${GITHUB_USERNAME:-x-access-token}
      GITHUB_EMAIL: ${GITHUB_EMAIL:-autobyteus-bot@autobyteus.dev}
      GITHUB_PAT: ${GITHUB_PAT:-}
      AUTOBYTEUS_GITHUB_ORG: ${AUTOBYTEUS_GITHUB_ORG:-AutoByteus}
      AUTOBYTEUS_REF: ${AUTOBYTEUS_REF:-main}
      AUTOBYTEUS_SERVER_REF: ${AUTOBYTEUS_SERVER_REF:-main}
      AUTOBYTEUS_TS_REF: ${AUTOBYTEUS_TS_REF:-main}
      AUTOBYTEUS_REPOSITORY_PRISMA_REF: ${AUTOBYTEUS_REPOSITORY_PRISMA_REF:-main}
      AUTOBYTEUS_SERVER_TS_REPO_URL: ${AUTOBYTEUS_SERVER_TS_REPO_URL:-}
      AUTOBYTEUS_TS_REPO_URL: ${AUTOBYTEUS_TS_REPO_URL:-}
      AUTOBYTEUS_REPOSITORY_PRISMA_REPO_URL: ${AUTOBYTEUS_REPOSITORY_PRISMA_REPO_URL:-}
      AUTOBYTEUS_SKIP_SYNC: ${AUTOBYTEUS_SKIP_SYNC:-0}
      AUTOBYTEUS_BIND_HOST: 0.0.0.0
      AUTOBYTEUS_SERVER_PORT: 8000
      AUTOBYTEUS_SERVER_HOST: ${AUTOBYTEUS_SERVER_HOST:-http://localhost:${AUTOBYTEUS_BACKEND_PORT:-8001}}
      AUTOBYTEUS_VNC_SERVER_HOSTS: ${AUTOBYTEUS_VNC_SERVER_HOSTS:-localhost:${AUTOBYTEUS_WEB_VNC_PORT:-6080}}
      AUTOBYTEUS_NODE_DISCOVERY_ENABLED: ${AUTOBYTEUS_NODE_DISCOVERY_ENABLED:-true}
      AUTOBYTEUS_NODE_DISCOVERY_ROLE: ${AUTOBYTEUS_NODE_DISCOVERY_ROLE:-client}
      AUTOBYTEUS_NODE_DISCOVERY_REGISTRY_URL: ${AUTOBYTEUS_NODE_DISCOVERY_REGISTRY_URL:-http://registry-node:8000}
      APP_ENV: ${APP_ENV:-production}
      PERSISTENCE_PROVIDER: ${PERSISTENCE_PROVIDER:-sqlite}
      DB_TYPE: ${DB_TYPE:-sqlite}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      AUTOBYTEUS_HTTP_ACCESS_LOG_MODE: ${AUTOBYTEUS_HTTP_ACCESS_LOG_MODE:-errors}
      AUTOBYTEUS_HTTP_ACCESS_LOG_INCLUDE_NOISY: ${AUTOBYTEUS_HTTP_ACCESS_LOG_INCLUDE_NOISY:-false}
    ports:
      - "${AUTOBYTEUS_BACKEND_PORT:-8001}:8000"
      - "${AUTOBYTEUS_VNC_PORT:-5908}:5900"
      - "${AUTOBYTEUS_WEB_VNC_PORT:-6080}:6080"
      - "${AUTOBYTEUS_CHROME_DEBUG_PORT:-9228}:9223"
    volumes:
      - ./.env:/app/autobyteus-server-ts/.env:ro
      - autobyteus-server-workspace:/home/autobyteus/workspace
      - autobyteus-server-data:/home/autobyteus/data
    restart: unless-stopped

volumes:
  autobyteus-server-workspace:
  autobyteus-server-data:
