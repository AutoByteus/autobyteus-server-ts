name: Release Docker Image

on:
  push:
    tags:
      - "v*.*.*"
      - "*.*.*"

permissions:
  contents: read

env:
  DEFAULT_IMAGE_NAME: autobyteus/autobyteus-server
  DEFAULT_AUTOBYTEUS_TS_REF: main
  DEFAULT_REPOSITORY_PRISMA_REF: main

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout autobyteus-server-ts
        uses: actions/checkout@v4
        with:
          path: autobyteus-server-ts
          fetch-depth: 1

      - name: Checkout autobyteus-ts
        uses: actions/checkout@v4
        with:
          repository: AutoByteus/autobyteus-ts
          ref: ${{ env.DEFAULT_AUTOBYTEUS_TS_REF }}
          path: autobyteus-ts
          fetch-depth: 1

      - name: Checkout repository_prisma
        uses: actions/checkout@v4
        with:
          repository: ryan-zheng-teki/repository_prisma
          ref: ${{ env.DEFAULT_REPOSITORY_PRISMA_REF }}
          path: repository_prisma
          fetch-depth: 1

      - name: Prepare monorepo build context
        run: |
          set -euo pipefail

          cp autobyteus-server-ts/pnpm-lock.yaml ./pnpm-lock.yaml
          cat > ./pnpm-workspace.yaml <<'EOF'
          packages:
            - "autobyteus-server-ts"
            - "autobyteus-ts"
            - "repository_prisma"
          EOF

      - name: Compute Docker tags
        id: tags
        env:
          IMAGE_NAME_INPUT: ""
          RELEASE_TAG_INPUT: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          IMAGE_NAME="${IMAGE_NAME_INPUT:-$DEFAULT_IMAGE_NAME}"

          RELEASE_TAG="${RELEASE_TAG_INPUT}"
          if [[ -z "${RELEASE_TAG}" ]]; then
            RELEASE_TAG="$(node -p "require('./autobyteus-server-ts/package.json').version")"
          fi

          CLEAN_TAG="${RELEASE_TAG#v}"

          {
            echo "image_name=${IMAGE_NAME}"
            echo "release_tag=${RELEASE_TAG}"
            echo "tags<<EOF"
            echo "${IMAGE_NAME}:${RELEASE_TAG}"
            if [[ "${CLEAN_TAG}" != "${RELEASE_TAG}" ]]; then
              echo "${IMAGE_NAME}:${CLEAN_TAG}"
            fi
            echo "${IMAGE_NAME}:latest"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: autobyteus-server-ts/docker/Dockerfile.monorepo
          platforms: linux/amd64,linux/arm64
          push: true
          provenance: false
          sbom: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.tags.outputs.tags }}

      - name: Publish summary
        run: |
          {
            echo "### Docker image published"
            echo ""
            echo "Image: \`${{ steps.tags.outputs.image_name }}\`"
            echo "Release tag: \`${{ steps.tags.outputs.release_tag }}\`"
            echo ""
            echo "Tags:"
            echo "${{ steps.tags.outputs.tags }}" | sed 's/^/- `/' | sed 's/$/`/'
          } >> "${GITHUB_STEP_SUMMARY}"
