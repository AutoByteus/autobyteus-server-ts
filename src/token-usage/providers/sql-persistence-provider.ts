import type { TokenUsageRecord } from "../domain/models.js";
import { PrismaConverter } from "../converters/prisma-converter.js";
import { SqlTokenUsageRecordRepository } from "../repositories/sql/token-usage-record-repository.js";
import type { PersistenceProvider } from "./persistence-provider.js";

const logger = {
  error: (...args: unknown[]) => console.error(...args),
};

export class SqlPersistenceProvider implements PersistenceProvider {
  private recordRepository: SqlTokenUsageRecordRepository;
  private converter: PrismaConverter;

  constructor() {
    this.recordRepository = new SqlTokenUsageRecordRepository();
    this.converter = new PrismaConverter();
  }

  async createTokenUsageRecord(
    agentId: string,
    role: string,
    tokenCount: number,
    cost: number,
    llmModel?: string | null,
  ): Promise<TokenUsageRecord> {
    try {
      const createdRecord = await this.recordRepository.createUsageRecord({
        agentId,
        role,
        tokenCount,
        cost,
        llmModel,
      });
      return this.converter.toDomainRecord(createdRecord);
    } catch (error) {
      logger.error(`Failed to create token usage record: ${String(error)}`);
      throw error;
    }
  }

  async getTotalCostInPeriod(startDate: Date, endDate: Date): Promise<number> {
    try {
      return await this.recordRepository.getTotalCostInPeriod(startDate, endDate);
    } catch (error) {
      logger.error(`Failed to calculate total cost in period: ${String(error)}`);
      throw error;
    }
  }

  async getUsageRecordsInPeriod(
    startDate: Date,
    endDate: Date,
    llmModel?: string | null,
  ): Promise<TokenUsageRecord[]> {
    try {
      const records = await this.recordRepository.getUsageRecordsInPeriod({
        startDate,
        endDate,
        llmModel,
      });
      return this.converter.toDomainRecords(records);
    } catch (error) {
      logger.error(`Failed to retrieve token usage records in period: ${String(error)}`);
      throw error;
    }
  }
}
